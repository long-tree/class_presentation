<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowAudio AI æµç¨‹æ¶æ„</title>
    <style>
        :root {
            --font-stack: "PingFang SC", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.65);
            --node-bg: rgba(30, 30, 35, 0.8);
            --node-border: rgba(255, 255, 255, 0.15);
            --line-color: rgba(255, 255, 255, 0.2);
            --flow-color: #a18cd1; /* åŠ¨æ€æµå…‰é¢œè‰² */
            --bg-gradient: radial-gradient(circle at 50% 50%, #151525 0%, #050505 80%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-gradient);
            color: var(--text-primary);
            font-family: var(--font-stack);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- èˆå°å®¹å™¨ (æ ¸å¿ƒä¿®å¤ï¼šå›ºå®šæ¯”ä¾‹ç¡®ä¿è¿çº¿ä¸é”™ä½) --- */
        .stage-wrapper {
            width: 1200px;
            height: 700px;
            position: relative;
            /* è‡ªé€‚åº”ç¼©æ”¾ */
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .slide {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            display: none; /* å½»åº•éšè—éæ´»åŠ¨å¹»ç¯ç‰‡ */
        }

        .slide.active {
            opacity: 1;
            display: block;
            pointer-events: auto;
        }

        /* --- æ ‡é¢˜åŒºåŸŸ --- */
        .header {
            position: absolute;
            top: 40px;
            left: 50px;
            z-index: 10;
        }
        .header h2 { font-size: 2.2rem; margin-bottom: 8px; font-weight: 600; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .header p { font-size: 1rem; color: var(--text-secondary); }

        /* --- èŠ‚ç‚¹æ ·å¼ --- */
        .node {
            position: absolute;
            width: 180px;
            height: 90px;
            background: var(--node-bg);
            border: 1px solid var(--node-border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 2;
            transition: transform 0.3s;
        }
        
        .node:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.4); }
        
        .node-icon { font-size: 1.8rem; margin-bottom: 5px; }
        .node-title { font-size: 1rem; font-weight: bold; color: #fff; }
        .node-desc { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }

        /* ç‰¹æ®ŠèŠ‚ç‚¹é…è‰² */
        .node.start { border-color: rgba(100, 255, 120, 0.4); box-shadow: 0 0 20px rgba(100, 255, 120, 0.1); }
        .node.ai { border-color: rgba(161, 140, 209, 0.5); }
        .node.db { border-color: rgba(255, 180, 100, 0.4); }
        .node.output { border-color: rgba(100, 200, 255, 0.4); }

        /* --- SVG è¿çº¿å±‚ --- */
        .connections {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        path {
            fill: none;
            stroke: var(--line-color);
            stroke-width: 2;
        }

        /* åŠ¨æ€æµå…‰çº¿ */
        path.active-flow {
            stroke: var(--flow-color);
            stroke-dasharray: 10 10;
            stroke-opacity: 0.8;
            animation: flowAnimation 2s linear infinite;
        }

        @keyframes flowAnimation {
            from { stroke-dashoffset: 40; }
            to { stroke-dashoffset: 0; }
        }

        /* --- å¯¼èˆªæŒ‰é’® --- */
        .nav-controls {
            position: fixed;
            bottom: 30px;
            display: flex;
            gap: 20px;
            z-index: 100;
        }
        .btn {
            padding: 10px 24px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }

    </style>
</head>
<body>

    <!-- èˆå°å®¹å™¨ï¼šç”¨äºé”å®š SVG åæ ‡ -->
    <div class="stage-wrapper" id="stage">

        <!-- ================= PAGE 1: æ ¸å¿ƒè·¯ç”±æ€»è§ˆ ================= -->
        <div class="slide active" id="slide1">
            <div class="header">
                <h2>æ ¸å¿ƒæµç¨‹æ€»è§ˆ</h2>
                <p>ç”¨æˆ·æ„å›¾è¯†åˆ«ä¸åˆ†å‘è·¯ç”± (Router)</p>
            </div>

            <!-- Nodes (Coordinates Manually Locked) -->
            <!-- Col 1: Start -->
            <div class="node start" style="left: 100px; top: 305px;">
                <span class="node-icon">ğŸ¤</span>
                <span class="node-title">ç”¨æˆ·è¾“å…¥</span>
                <span class="node-desc">è¯­éŸ³ / æ–‡æœ¬</span>
            </div>

            <!-- Col 2: Router -->
            <div class="node ai" style="left: 400px; top: 305px;">
                <span class="node-icon">ğŸ”€</span>
                <span class="node-title">æ„å›¾è¯†åˆ«ç½‘å…³</span>
                <span class="node-desc">Doubao-flash</span>
            </div>

            <!-- Col 3: Branches -->
            <!-- Top: Music -->
            <div class="node" style="left: 800px; top: 120px;">
                <span class="node-icon">ğŸµ</span>
                <span class="node-title">DJ éŸ³ä¹ä»£ç†</span>
                <span class="node-desc">ç”ŸæˆéŸ³ä¹å‚æ•°</span>
            </div>
            <!-- Mid: Fast -->
            <div class="node" style="left: 800px; top: 305px;">
                <span class="node-icon">âš¡</span>
                <span class="node-title">å¿«é€Ÿå›å¤</span>
                <span class="node-desc">é—²èŠçŸ­å“åº”</span>
            </div>
            <!-- Bot: Loop -->
            <div class="node" style="left: 800px; top: 490px;">
                <span class="node-icon">ğŸ”„</span>
                <span class="node-title">åŒä¸»æ’­å¾ªç¯</span>
                <span class="node-desc">æ·±åº¦è¯é¢˜äº’åŠ¨</span>
            </div>

            <!-- Lines -->
            <svg class="connections">
                <!-- Start -> Router -->
                <path class="active-flow" d="M 280 350 L 400 350" />
                
                <!-- Router -> Top -->
                <path class="active-flow" d="M 580 350 C 650 350, 650 165, 800 165" />
                
                <!-- Router -> Mid -->
                <path class="active-flow" d="M 580 350 L 800 350" />
                
                <!-- Router -> Bot -->
                <path class="active-flow" d="M 580 350 C 650 350, 650 535, 800 535" />
            </svg>
        </div>

        <!-- ================= PAGE 2: éŸ³ä¹ç”Ÿæˆé“¾è·¯ ================= -->
        <div class="slide" id="slide2">
            <div class="header">
                <h2>AI éŸ³ä¹ç”Ÿæˆé“¾è·¯</h2>
                <p>ä»è‡ªç„¶è¯­è¨€åˆ° Lyria éŸ³ä¹å‚æ•°</p>
            </div>

            <div class="node ai" style="left: 100px; top: 300px;">
                <span class="node-icon">ğŸ§</span>
                <span class="node-title">DJ å¤§æ¨¡å‹</span>
                <span class="node-desc">æŒ‡ä»¤å¾®è°ƒ (SFT)</span>
            </div>

            <div class="node" style="left: 360px; top: 300px;">
                <span class="node-icon">ğŸ“„</span>
                <span class="node-title">JSON åºåˆ—åŒ–</span>
                <span class="node-desc">æ ¼å¼æ ¡éªŒ</span>
            </div>

            <div class="node db" style="left: 620px; top: 300px;">
                <span class="node-icon">ğŸ¼</span>
                <span class="node-title">å‚æ•°æ˜ å°„</span>
                <span class="node-desc">BPM / è°ƒå¼ / æƒ…æ„Ÿ</span>
            </div>

            <div class="node output" style="left: 880px; top: 300px;">
                <span class="node-icon">ğŸ¹</span>
                <span class="node-title">Lyria å¼•æ“</span>
                <span class="node-desc">éŸ³é¢‘æµè¾“å‡º</span>
            </div>

            <svg class="connections">
                <path class="active-flow" d="M 280 345 L 360 345" />
                <path class="active-flow" d="M 540 345 L 620 345" />
                <path class="active-flow" d="M 800 345 L 880 345" />
            </svg>
        </div>

        <!-- ================= PAGE 3: è®°å¿†ä¸è¯é¢˜ (RAG) ================= -->
        <div class="slide" id="slide3">
            <div class="header">
                <h2>è¯é¢˜å¢å¼ºä¸è®°å¿† (RAG)</h2>
                <p>SQL æ•°æ®åº“ + MemOS å‘é‡æ£€ç´¢</p>
            </div>

            <!-- Top Input -->
            <div class="node db" style="left: 150px; top: 180px;">
                <span class="node-icon">ğŸ—ƒï¸</span>
                <span class="node-title">SQL è¯é¢˜åº“</span>
                <span class="node-desc">é¢„ç½® / å¼¹å¹•è¯é¢˜</span>
            </div>

            <!-- Bot Input -->
            <div class="node db" style="left: 150px; top: 420px;">
                <span class="node-icon">ğŸ§ </span>
                <span class="node-title">MemOS è®°å¿†åº“</span>
                <span class="node-desc">å‘é‡å†å²æ£€ç´¢</span>
            </div>

            <!-- Merge -->
            <div class="node" style="left: 450px; top: 300px;">
                <span class="node-icon">ğŸ“¦</span>
                <span class="node-title">å˜é‡èšåˆ</span>
                <span class="node-desc">ä¸Šä¸‹æ–‡ç»„è£…</span>
            </div>

            <!-- Thinking -->
            <div class="node ai" style="left: 710px; top: 300px;">
                <span class="node-icon">ğŸ’­</span>
                <span class="node-title">æ·±åº¦æ€è€ƒæ¨¡å‹</span>
                <span class="node-desc">Baobab Core</span>
            </div>

            <!-- Update -->
            <div class="node output" style="left: 970px; top: 300px;">
                <span class="node-icon">ğŸ’¾</span>
                <span class="node-title">è®°å¿†å†™å…¥</span>
                <span class="node-desc">æ›´æ–°å‘é‡åº“</span>
            </div>

            <svg class="connections">
                <!-- Top to Merge -->
                <path class="active-flow" d="M 330 225 C 380 225, 380 345, 450 345" />
                <!-- Bot to Merge -->
                <path class="active-flow" d="M 330 465 C 380 465, 380 345, 450 345" />
                
                <!-- Merge to Think -->
                <path class="active-flow" d="M 630 345 L 710 345" />
                
                <!-- Think to Update -->
                <path class="active-flow" d="M 890 345 L 970 345" />
            </svg>
        </div>

        <!-- ================= PAGE 4: åŒå¥³ä¸»æ’­å¾ªç¯ ================= -->
        <div class="slide" id="slide4">
            <div class="header">
                <h2>åŒå¥³ä¸»æ’­äº’åŠ¨å¾ªç¯</h2>
                <p>Baobab & Acacia äº¤äº’ä½“ç³»</p>
            </div>

            <!-- Left: Baobab -->
            <div class="node ai" style="left: 150px; top: 250px; border-color: #a18cd1;">
                <span class="node-icon">ğŸ‘©ğŸ»</span>
                <span class="node-title">Baobab</span>
                <span class="node-desc"></span>
            </div>

            <!-- Middle: Logic -->
            <div class="node" style="left: 510px; top: 250px;">
                <span class="node-icon">ğŸ”„</span>
                <span class="node-title">å¾ªç¯æ§åˆ¶å™¨</span>
                <span class="node-desc">è½®æ¬¡æ§åˆ¶ / åˆ¤æ–­</span>
            </div>

            <!-- Right: Acacia -->
            <div class="node ai" style="left: 870px; top: 250px; border-color: #fbc2eb;">
                <span class="node-icon">ğŸ‘©ğŸ¼</span>
                <span class="node-title">Acacia</span>
                <span class="node-desc"></span>
            </div>

            <!-- TTS Outputs -->
            <div class="node output" style="left: 330px; top: 500px; width: 140px; height: 70px;">
                <span class="node-icon">ğŸ”Š</span>
                <span class="node-title">è¯­éŸ³åˆæˆ</span>
            </div>
            
            <div class="node output" style="left: 730px; top: 500px; width: 140px; height: 70px;">
                <span class="node-icon">ğŸ”Š</span>
                <span class="node-title">è¯­éŸ³åˆæˆ</span>
            </div>

            <svg class="connections">
                <!-- Baobab to Loop -->
                <path class="active-flow" d="M 330 295 L 510 295" />
                
                <!-- Loop to Acacia -->
                <path class="active-flow" d="M 690 295 L 870 295" />
                
                <!-- Acacia back to Loop (Curved Top) -->
                <path class="" d="M 960 250 C 960 100, 240 100, 240 250" style="stroke-dasharray: 8; stroke-opacity: 0.3;" />
                
                <!-- TTS Connections -->
                <path class="" d="M 240 340 L 400 500" />
                <path class="" d="M 960 340 L 800 500" />
            </svg>
        </div>

    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="nav-controls">
        <button class="btn" onclick="showSlide(1)">1. æ ¸å¿ƒè·¯ç”±</button>
        <button class="btn" onclick="showSlide(2)">2. éŸ³ä¹é“¾è·¯</button>
        <button class="btn" onclick="showSlide(3)">3. è®°å¿†ä¸è¯é¢˜</button>
        <button class="btn" onclick="showSlide(4)">4. åŒäººå¾ªç¯</button>
        <button class="btn" onclick="exitToMemory()" style="border: 1px solid #fff; color: #fff;">é€€å‡ºè¿”å›</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const fromParam = parseInt(params.get('from'), 10);
        if (Number.isFinite(fromParam)) {
            try { localStorage.setItem('cozeReturnSlide', fromParam); } catch (e) {}
        }

        function getReturnSlide() {
            if (Number.isFinite(fromParam)) return fromParam;
            const stored = parseInt(localStorage.getItem('cozeReturnSlide'), 10);
            return Number.isFinite(stored) ? stored : 4; // é»˜è®¤å›åˆ°è®°å¿†é¡µ
        }

        // è‡ªé€‚åº”ç¼©æ”¾é€»è¾‘
        function resizeStage() {
            const stage = document.getElementById('stage');
            const scaleX = window.innerWidth / 1300;
            const scaleY = window.innerHeight / 800;
            const scale = Math.min(scaleX, scaleY, 1); // é™åˆ¶æœ€å¤§ç¼©æ”¾ä¸º1
            stage.style.transform = `scale(${scale})`;
        }

        window.addEventListener('resize', resizeStage);
        resizeStage(); // åˆå§‹åŒ–æ‰§è¡Œ

        // å¹»ç¯ç‰‡åˆ‡æ¢é€»è¾‘
        function showSlide(index) {
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            document.getElementById('slide' + index).classList.add('active');
        }

        // é€€å‡ºæŒ‰é’®ï¼šå›åˆ°è®°å¿†é¡µï¼Œå¹¶é€šçŸ¥çˆ¶/åŸé¡µé¢
        function exitToMemory() {
            const target = getReturnSlide();
            showSlide(3);

            // å†…åµŒ iframe æƒ…å†µï¼šé€šçŸ¥çˆ¶é¡µé¢
            if (window.parent && window.parent !== window) {
                if (typeof window.parent.exitFromCoze === 'function') {
                    try { window.parent.exitFromCoze(target); return; } catch (e) {}
                }
                if (typeof window.parent.toggleCozeEmbed === 'function') {
                    try { window.parent.toggleCozeEmbed(); return; } catch (e) {}
                }
            }

            // æ–°æ ‡ç­¾é¡µæƒ…å†µï¼šé€šçŸ¥ opener å¹¶å°è¯•å…³é—­è‡ªèº«
            let notified = false;
            if (window.opener && !window.opener.closed) {
                try {
                    if (typeof window.opener.exitFromCoze === 'function') {
                        window.opener.exitFromCoze(target);
                        notified = true;
                    } else if (typeof window.opener.updateSlide === 'function') {
                        window.opener.updateSlide(target); // 0-based
                        notified = true;
                    }
                    if (notified && typeof window.opener.focus === 'function') {
                        window.opener.focus();
                    }
                } catch (e) {}
            }

            if (notified) {
                try { window.close(); } catch (e) {}
                return;
            }

            // æ— æ³•é€šçŸ¥æ—¶ï¼Œç›´æ¥è·³å› b.html è®°å¿†é¡µï¼ˆåŒç›®å½•ï¼‰
            window.location.href = `b.html?slide=${target}`;
        }
    </script>
</body>
</html>
